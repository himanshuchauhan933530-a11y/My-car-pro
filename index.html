<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Chat App - Pro Version</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --wa-header-bg: #005c97;
            --wa-accent-blue: #34B7F1;
            --wa-message-out-bg: #e1f6fb;
            --wa-message-in-bg: #ffffff;
            --wa-app-bg: #f0f2f5;
            --wa-chat-bg: #e5ddd5;
            --wa-text-primary: #111b21;
            --wa-border-color: #e9edef;
            --danger: #e91e63;
            --success: #4CAF50;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        body { background-color: #d1d7db; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }

        #app-container { width: 100%; max-width: 450px; height: 100%; max-height: 950px; background: var(--wa-app-bg); position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.15); overflow: hidden; display: flex; flex-direction: column; }
        .view { display: none; flex-direction: column; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: var(--wa-app-bg); }
        .view.active { display: flex; }

        /* Auth */
        #auth-view { justify-content: center; align-items: center; padding: 20px; background: linear-gradient(to bottom, var(--wa-header-bg), #003a61); }
        .auth-card { background: white; padding: 30px; border-radius: 12px; width: 90%; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--wa-border-color); border-radius: 6px; outline: none; }
        .primary-btn { background: var(--wa-header-bg); color: white; padding: 12px; width: 100%; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; }

        /* Header */
        .main-header { background: var(--wa-header-bg); color: white; position: relative; }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 15px; }
        .header-nav { display: flex; }
        .nav-tab { flex: 1; text-align: center; padding: 12px; font-size: 13px; cursor: pointer; color: rgba(255,255,255,0.6); transition: 0.3s; }
        .nav-tab.active { color: white; border-bottom: 3px solid var(--wa-accent-blue); }

        /* Menu Dot */
        .menu-dropdown { position: absolute; right: 10px; top: 50px; background: white; color: black; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: none; z-index: 3000; min-width: 150px; }
        .menu-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; }
        .menu-item:hover { background: #f5f5f5; }

        /* Lists */
        .list-item { display: flex; align-items: center; padding: 12px 15px; background: white; border-bottom: 1px solid #eee; cursor: pointer; user-select: none; }
        .user-pic { width: 45px; height: 45px; border-radius: 50%; background: #ddd; margin-right: 12px; object-fit: cover; }
        .status-circle { border: 3px solid var(--wa-accent-blue); padding: 2px; }

        /* Chat */
        #chat-messages { flex: 1; background: var(--wa-chat-bg); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        .message-bubble { max-width: 80%; padding: 10px; margin-bottom: 8px; border-radius: 8px; font-size: 14px; position: relative; cursor: pointer; transition: 0.2s; }
        .message-bubble:active { opacity: 0.7; }
        .message-sent { align-self: flex-end; background: var(--wa-message-out-bg); }
        .message-received { align-self: flex-start; background: var(--wa-message-in-bg); }
        .chat-img { max-width: 100%; border-radius: 8px; margin-top: 5px; }

        /* Calls */
        .call-view { z-index: 1000; background: #0b141a; color: white; display: none; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 100px; height: 140px; position: absolute; top: 20px; right: 20px; border-radius: 8px; border: 2px solid white; }

        /* Modals */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 85%; padding: 20px; border-radius: 12px; max-height: 80vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; color: #333; cursor: pointer; font-weight: bold; }

        .hidden { display: none !important; }
        .icon-btn { background: none; border: none; color: white; cursor: pointer; padding: 5px; }
        svg { width: 24px; height: 24px; fill: currentColor; }
    </style>
</head>
<body>

<div id="app-container">

    <div id="auth-view" class="view active">
        <div class="auth-card">
            <h2 style="text-align:center; margin-bottom:10px; color: var(--wa-header-bg);">My Chat App</h2>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" class="primary-btn">LOGIN</button>
                <p style="text-align:center; margin-top:15px; cursor:pointer; color:var(--wa-accent-blue)" onclick="toggleAuth(false)">Create Account</p>
            </form>
            <form id="signup-form" class="hidden">
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password" required>
                <button type="submit" class="primary-btn">SIGN UP</button>
                <p style="text-align:center; margin-top:15px; cursor:pointer; color:var(--wa-accent-blue)" onclick="toggleAuth(true)">Back to Login</p>
            </form>
        </div>
    </div>

    <div id="main-view" class="view">
        <header class="main-header">
            <div class="header-top">
                <h3>My Chat App</h3>
                <div style="display:flex; gap:10px;">
                    <button id="add-friend-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></button>
                    <button id="three-dot-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></button>
                </div>
                <div id="main-menu" class="menu-dropdown">
                    <div class="menu-item" onclick="showModal('profile-settings-modal')">Settings</div>
                    <div class="menu-item" onclick="showModal('create-group-modal')">New Group</div>
                    <div class="menu-item" onclick="logoutApp()">Logout</div>
                </div>
            </div>
            <div class="header-nav">
                <div class="nav-tab active" onclick="showTab('chats')">CHATS</div>
                <div class="nav-tab" onclick="showTab('groups')">GROUPS</div>
                <div class="nav-tab" onclick="showTab('updates')">REQUESTS</div>
                <div class="nav-tab" onclick="showTab('status')">STATUS</div>
            </div>
        </header>
        <div id="tab-content" style="flex:1; overflow-y:auto;">
            <div id="chats-list"></div>
            <div id="groups-list" class="hidden"></div>
            <div id="updates-list" class="hidden"></div>
            <div id="status-view" class="hidden">
                <div class="list-item" id="my-status-item">
                    <div style="position:relative;">
                        <img id="my-status-pic" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="user-pic status-circle">
                        <div style="position:absolute; bottom:0; right:10px; background:var(--success); color:white; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; cursor: pointer;" onclick="document.getElementById('status-input').click()">+</div>
                    </div>
                    <div onclick="openMyStatus()"><b>My Status</b><br><small id="status-time">Tap to add new status</small></div>
                </div>
                <input type="file" id="status-input" accept="image/*" style="display:none;">
                <hr><h4 style="padding:10px; color:var(--wa-text-secondary); font-size: 14px;">Recent Updates</h4>
                <div id="others-status"></div>
            </div>
        </div>
    </div>

    <div id="chat-view" class="view">
        <header class="main-header" style="display:flex; align-items:center; padding:10px;">
            <button onclick="showView('main-view')" class="icon-btn" style="margin-right:5px;"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
            <img id="chat-pic" src="" class="user-pic" style="width:35px; height:35px;">
            <div style="flex:1;">
                <b id="chat-title">Name</b><br>
                <small id="chat-status" style="font-size: 10px; color: #ddd;">Offline</small>
            </div>
            <button id="audio-call-btn" class="icon-btn" style="margin-right:10px;"><svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg></button>
            <button id="v-call-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></button>
        </header>
        <div id="chat-messages"></div>
        <div style="padding:10px; background:white; display:flex; align-items:center;">
            <label for="chat-file-input" class="icon-btn" style="color:var(--wa-header-bg);"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></label>
            <input type="file" id="chat-file-input" accept="image/*" style="display:none;">
            <input type="text" id="msg-input" placeholder="Message..." style="flex:1; margin:0 5px;">
            <button id="send-btn" class="primary-btn" style="width:auto; padding: 10px 15px;">SEND</button>
        </div>
    </div>

    <div id="profile-settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">×</span>
            <h3>Profile Settings</h3>
            <div style="text-align:center; margin:15px 0;">
                <img id="settings-preview-pic" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="user-pic" style="width:100px; height:100px; cursor:pointer; border: 2px solid var(--wa-accent-blue);" onclick="document.getElementById('profile-pic-input').click()">
                <p style="font-size: 11px; color: #666; margin-top: 5px;">Click photo to change</p>
                <input type="file" id="profile-pic-input" accept="image/*" style="display:none;">
            </div>
            <input type="text" id="new-username" placeholder="New Username">
            <input type="text" id="new-display-name" placeholder="New Name">
            <button onclick="updateProfile()" class="primary-btn">UPDATE & START</button>
        </div>
    </div>

    <div id="create-group-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">×</span>
            <h3>Create New Group</h3>
            <input type="text" id="group-name-input" placeholder="Group Name">
            <div id="friend-select-list" style="max-height:150px; overflow-y:auto; border:1px solid #ddd; margin:10px 0;"></div>
            <button onclick="createNewGroup()" id="create-group-submit" class="primary-btn">CREATE GROUP</button>
        </div>
    </div>

    <div id="video-call-view" class="view call-view">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div style="position:absolute; bottom:40px; width:100%; text-align:center;">
            <button onclick="endCall()" class="primary-btn" style="background:var(--danger); width:70px; border-radius:50%; height:70px;">END</button>
        </div>
    </div>

    <div id="status-modal" class="modal" onclick="closeModals()">
        <div class="modal-content" style="background:black; padding:0; height:100%; width:100%; display:flex; align-items:center; justify-content:center; position:relative;">
            <div style="position:absolute; top:20px; left:20px; color:white; font-weight:bold; z-index:10;" id="status-user-name">User Name</div>
            <img id="full-status-img" src="" style="width:100%; max-height:100%; object-fit:contain;">
        </div>
    </div>

    <div id="friend-modal" class="modal"><div class="modal-content">
        <span class="close-modal" onclick="closeModals()">×</span>
        <h3>Add Friend</h3>
        <input type="text" id="target-username" placeholder="Enter Username">
        <button onclick="sendRequest()" class="primary-btn">SEND REQUEST</button>
    </div></div>

    <div id="incoming-modal" class="modal"><div class="modal-content" style="text-align:center;">
        <h3 id="call-type-title">Incoming Call</h3><p id="caller-info">...</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="acceptCall()" class="primary-btn" style="background:var(--success)">ACCEPT</button>
            <button onclick="rejectCall()" class="primary-btn" style="background:var(--danger)">REJECT</button>
        </div>
    </div></div>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyC2vcHeznuJJhtua-wnP2YAmz8M15zg3XQ",
      authDomain: "my-chat-app-79245.firebaseapp.com",
      databaseURL: "https://my-chat-app-79245-default-rtdb.firebaseio.com",
      projectId: "my-chat-app-79245",
      storageBucket: "my-chat-app-79245.firebasestorage.app",
      messagingSenderId: "523017829697",
      appId: "1:523017829697:web:68f9f840cf9ecc1456b5c0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null, activeChatId = null, localStream = null, peerConnection = null, myStatuses = [], myContacts = [];

    function showView(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function showModal(id) { document.getElementById(id).style.display = 'flex'; document.getElementById('main-menu').style.display='none'; }
    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
    function toggleAuth(isLogin) { document.getElementById('login-form').classList.toggle('hidden', !isLogin); document.getElementById('signup-form').classList.toggle('hidden', isLogin); }
    document.getElementById('three-dot-btn').onclick = (e) => { e.stopPropagation(); const m = document.getElementById('main-menu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; };
    window.onclick = () => { document.getElementById('main-menu').style.display = 'none'; };

    function showTab(tab) {
        ['chats-list','groups-list','updates-list','status-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(tab + (tab === 'status' ? '-view' : '-list')).classList.remove('hidden');
        const tabs = document.querySelectorAll('.nav-tab');
        tabs.forEach((t, i) => t.classList.toggle('active', ['chats','groups','updates','status'][i] === tab));
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            db.ref(`users/${user.uid}`).once('value').then(snap => {
                const data = snap.val();
                if(!data || !data.username) showModal('profile-settings-modal');
                else { currentUser.profile = data; showView('main-view'); initApp(); updateOnlineStatus(); }
            });
        } else showView('auth-view');
    });

    function updateOnlineStatus() {
        if(!currentUser) return;
        const userRef = db.ref(`users/${currentUser.uid}/status`);
        userRef.set("online");
        userRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
    }

    function logoutApp() {
        if(currentUser) db.ref(`users/${currentUser.uid}/status`).set(firebase.database.ServerValue.TIMESTAMP);
        auth.signOut().then(() => { window.location.reload(); });
    }

    async function updateProfile() {
        const username = document.getElementById('new-username').value.toLowerCase().trim();
        const name = document.getElementById('new-display-name').value.trim();
        const pic = document.getElementById('settings-preview-pic').src;
        if(!username || !name) return alert("Fill all details");
        const check = await db.ref(`usernames/${username}`).once('value');
        if(check.exists() && check.val() !== currentUser.uid) return alert("Username taken!");
        if(currentUser.profile && currentUser.profile.username && currentUser.profile.username !== username) await db.ref(`usernames/${currentUser.profile.username}`).remove();
        await db.ref(`usernames/${username}`).set(currentUser.uid);
        await db.ref(`users/${currentUser.uid}`).update({ username, name, pic, uid: currentUser.uid });
        closeModals();
        window.location.reload();
    }

    function initApp() {
        db.ref(`contacts/${currentUser.uid}`).on('value', snap => {
            const list = document.getElementById('chats-list'), sel = document.getElementById('friend-select-list');
            list.innerHTML = ''; sel.innerHTML = ''; myContacts = [];
            snap.forEach(child => {
                const c = child.val(); myContacts.push(c.uid);
                list.innerHTML += `<div class="list-item" onclick="openChat('${c.uid}', 'private')"><img src="${c.pic || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="user-pic"><div><b>${c.name}</b><br><small>@${c.username}</small></div></div>`;
                sel.innerHTML += `<div style="padding:5px"><input type="checkbox" value="${c.uid}" class="group-member-check"> ${c.name}</div>`;
            });
        });

        // FIXED STATUS LOGIC
        db.ref('status').on('value', snap => {
            const list = document.getElementById('others-status'); list.innerHTML = ''; myStatuses = [];
            const allStatusData = snap.val() || {};
            
            Object.keys(allStatusData).forEach(uId => {
                const userStatuses = Object.values(allStatusData[uId]);
                const lastS = userStatuses[userStatuses.length - 1];
                
                if(uId === currentUser.uid) {
                   document.getElementById('my-status-pic').src = lastS.img;
                   myStatuses = userStatuses;
                   document.getElementById('status-time').innerText = "Status updated";
                } else if(myContacts.includes(uId)) {
                   const div = document.createElement('div');
                   div.className = 'list-item';
                   div.onclick = () => viewStatus(lastS.img, lastS.name);
                   div.innerHTML = `<img src="${lastS.img}" class="user-pic status-circle"><div><b>${lastS.name}</b><br><small>View Status Update</small></div>`;
                   list.appendChild(div);
                }
            });
        });

        db.ref(`user_groups/${currentUser.uid}`).on('value', snap => {
            const list = document.getElementById('groups-list'); list.innerHTML = '';
            snap.forEach(child => {
                const g = child.val();
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/615/615075.png" class="user-pic"><div><b>${g.name}</b><br><small>Group Chat</small></div>`;
                
                let timer;
                div.onmousedown = div.ontouchstart = () => { timer = setTimeout(() => deleteGroup(g.id), 800); };
                div.onmouseup = div.ontouchend = () => { clearTimeout(timer); };
                div.onclick = () => openChat(g.id, 'group');
                list.appendChild(div);
            });
        });

        db.ref(`requests/${currentUser.uid}`).on('value', snap => {
            const list = document.getElementById('updates-list'); list.innerHTML = '';
            snap.forEach(child => {
                const r = child.val();
                list.innerHTML += `<div class="list-item"><img src="${r.pic || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="user-pic"><div style="flex:1"><b>@${r.username}</b></div><button onclick="acceptFriend('${r.uid}')" style="background:green;color:white;border:none;padding:8px;border-radius:4px">Accept</button></div>`;
            });
        });

        db.ref(`calls/${currentUser.uid}`).on('value', snap => {
            const call = snap.val(); if(call && call.status === 'ringing') { 
                document.getElementById('caller-info').innerText = call.fromName; 
                document.getElementById('call-type-title').innerText = `Incoming ${call.type} Call`; 
                showModal('incoming-modal'); 
            }
        });
    }

    async function deleteGroup(gId) {
        if(confirm("Do you want to delete this group?")) {
            await db.ref(`user_groups/${currentUser.uid}/${gId}`).remove();
            alert("Group removed from your list");
        }
    }

    function openChat(id, type) {
        activeChatId = id; showView('chat-view');
        const path = type === 'group' ? `groups/${id}` : `users/${id}`;
        db.ref(path).on('value', snap => { 
            const d = snap.val(); if(!d) return;
            document.getElementById('chat-title').innerText = d.name;
            document.getElementById('chat-pic').src = d.pic || (type==='group' ? 'https://cdn-icons-png.flaticon.com/512/615/615075.png' : 'https://cdn-icons-png.flaticon.com/512/149/149071.png');
            if(type === 'private') {
                const st = d.status;
                document.getElementById('chat-status').innerText = st === "online" ? "Online" : "Last seen: " + (st ? new Date(st).toLocaleTimeString() : "Unknown");
            } else document.getElementById('chat-status').innerText = "Group Chat";
        });
        const msgPath = `messages/${id}`;
        db.ref(msgPath).off(); document.getElementById('chat-messages').innerHTML = '';
        db.ref(msgPath).on('child_added', snap => {
            const m = snap.val(), key = snap.key;
            const div = document.createElement('div');
            div.className = `message-bubble ${m.sender === currentUser.uid ? 'message-sent' : 'message-received'}`;
            div.onclick = () => { if(confirm("Delete this message?")) db.ref(`messages/${id}/${key}`).remove().then(() => div.remove()); };
            div.innerHTML = m.type === 'image' ? `<b>${m.senderName}:</b><br><img src="${m.text}" class="chat-img">` : `<b>${m.senderName}:</b><br>${m.text}`;
            document.getElementById('chat-messages').appendChild(div);
            document.getElementById('chat-messages').scrollTop = 999999;
        });
    }

    document.getElementById('send-btn').onclick = () => {
        const text = document.getElementById('msg-input').value; if(!text) return;
        db.ref(`messages/${activeChatId}`).push({ sender: currentUser.uid, senderName: currentUser.profile.name, text, type: 'text', timestamp: Date.now() });
        document.getElementById('msg-input').value = '';
    };

    document.getElementById('chat-file-input').onchange = e => {
        const reader = new FileReader();
        reader.onload = () => { db.ref(`messages/${activeChatId}`).push({ sender: currentUser.uid, senderName: currentUser.profile.name, text: reader.result, type: 'image', timestamp: Date.now() }); };
        reader.readAsDataURL(e.target.files[0]);
    };

    async function createNewGroup() {
        const btn = document.getElementById('create-group-submit');
        const name = document.getElementById('group-name-input').value;
        if(!name) return alert("Group name required");
        if(btn.disabled) return; 

        btn.disabled = true; 
        const gId = 'group_' + Date.now(), members = [currentUser.uid];
        document.querySelectorAll('.group-member-check:checked').forEach(i => members.push(i.value));
        
        try {
            await db.ref(`groups/${gId}`).set({ id: gId, name, members });
            const updates = {};
            members.forEach(m => { updates[`user_groups/${m}/${gId}`] = { id: gId, name }; });
            await db.ref().update(updates);
            alert("Group Created!");
            closeModals();
        } catch(e) { alert("Error creating group"); }
        finally { btn.disabled = false; }
    }

    document.getElementById('status-input').onchange = e => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => { 
            db.ref(`status/${currentUser.uid}`).push({ uid: currentUser.uid, name: currentUser.profile.name, img: reader.result, timestamp: Date.now() }); 
        };
        reader.readAsDataURL(file);
    };

    async function startCall(t) {
        try {
            if (!window.isSecureContext && location.hostname !== "localhost") {
               alert("Call Error: HTTPS connection required for camera/mic.");
               return;
            }
            const s = await navigator.mediaDevices.getUserMedia({ video: t === 'Video', audio: true });
            localStream = s;
            showView('video-call-view');
            document.getElementById('local-video').srcObject = s;
            const callRef = db.ref(`calls/${activeChatId}`);
            await callRef.set({ from: currentUser.uid, fromName: currentUser.profile.name, status: 'ringing', type: t });
            callRef.on('value', snap => { if(!snap.val() || snap.val().status === 'ended') endCall(); });
        } catch(e) { alert("Call Error: " + e.message); }
    }
    
    async function acceptCall() {
        closeModals();
        try {
            const snap = await db.ref(`calls/${currentUser.uid}`).once('value');
            const callData = snap.val();
            const s = await navigator.mediaDevices.getUserMedia({ video: callData.type === 'Video', audio: true });
            localStream = s;
            showView('video-call-view');
            document.getElementById('local-video').srcObject = s;
            await db.ref(`calls/${currentUser.uid}`).update({ status: 'connected' });
        } catch(e) { alert("Camera Error: " + e.message); }
    }
    
    function endCall() { 
        if(localStream) { localStream.getTracks().forEach(tr => tr.stop()); localStream = null; }
        document.getElementById('local-video').srcObject = null;
        document.getElementById('remote-video').srcObject = null;
        showView('main-view');
        if(currentUser) db.ref(`calls/${currentUser.uid}`).remove(); 
        if(activeChatId) db.ref(`calls/${activeChatId}`).remove(); 
    }

    document.getElementById('v-call-btn').onclick = () => startCall('Video');
    document.getElementById('audio-call-btn').onclick = () => startCall('Audio');
    function openMyStatus() { if(myStatuses.length > 0) viewStatus(myStatuses[myStatuses.length-1].img, "My Status"); }
    function viewStatus(img, name) { document.getElementById('full-status-img').src = img; document.getElementById('status-user-name').innerText = name; showModal('status-modal'); }
    function rejectCall() { db.ref(`calls/${currentUser.uid}`).remove(); closeModals(); }
    document.getElementById('add-friend-btn').onclick = () => showModal('friend-modal');
    async function sendRequest() {
        const u = document.getElementById('target-username').value.toLowerCase().trim();
        const snap = await db.ref(`usernames/${u}`).once('value');
        if(snap.exists()) {
            db.ref(`requests/${snap.val()}/${currentUser.uid}`).set({ uid: currentUser.uid, username: currentUser.profile.username, pic: currentUser.profile.pic || '' });
            alert("Sent!"); closeModals();
        } else alert("Not found");
    }
    async function acceptFriend(uid) {
        const snap = await db.ref(`users/${uid}`).once('value');
        db.ref(`contacts/${currentUser.uid}/${uid}`).set(snap.val());
        db.ref(`contacts/${uid}/${currentUser.uid}`).set(currentUser.profile);
        db.ref(`requests/${currentUser.uid}/${uid}`).remove();
    }
    document.getElementById('profile-pic-input').onchange = e => {
        const reader = new FileReader();
        reader.onload = () => { document.getElementById('settings-preview-pic').src = reader.result; };
        reader.readAsDataURL(e.target.files[0]);
    };
</script>
</body>
</html>
